@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.merchandiseinbaggage.views.html.components
@import uk.gov.hmrc.merchandiseinbaggage.config.AppConfig
@import uk.gov.hmrc.merchandiseinbaggage.controllers.routes._
@import uk.gov.hmrc.merchandiseinbaggage.forms.JourneyDetailsForm._
@import uk.gov.hmrc.merchandiseinbaggage.model.core.JourneyDetailsEntry
@import uk.gov.hmrc.merchandiseinbaggage.model.core.DeclarationType
@import uk.gov.hmrc.merchandiseinbaggage.service.PortService
@import play.api.libs.json.Json

@this(
layout: Layout,
formHelper: FormWithCSRF,
errorSummary: components.errorSummary,
button: components.button,
inputSelect: components.inputSelect,
date: components.inputDate,
h1: components.h1)

@(form: Form[JourneyDetailsEntry], declarationType: DeclarationType, backButtonUrl: Call)(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

@head = {
    <link rel="stylesheet" href="@routes.Assets.versioned("lib/accessible-autocomplete/dist/accessible-autocomplete.min.css")" >
}

@scripts = {
    <script src="@routes.Assets.versioned("lib/accessible-autocomplete/dist/accessible-autocomplete.min.js")"></script>
    <script>

            var selectElementId = 'port'
            var submitOnConfirm = false
            var dataSource = @Html( Json.toJson(PortService.getAllPorts.map(_.toAutoCompleteJson)).toString )

                    accessibleAutocomplete.enhanceSelectElement({
                        selectElement: document.querySelector('#' + selectElementId),
                        displayMenu: 'inline',
                        minLength: 2,
                        source: customSuggest,
                        confirmOnBlur: true,
                        onConfirm: function(confirmed) {

                            //Workaround the bug sending confirmed = undefined when confirmOnBlur == true
                            let foundInData = dataSource.find(e => e.displayName === $('#'+selectElementId).val())
                            let element = !!confirmed ? confirmed : foundInData

                            if(!!element) {
                                $('select[name="'+selectElementId+'"]').val(element.code);
                                if(submitOnConfirm) {
                                    window.setTimeout(function(){
                                        $('form').submit();
                                    }, 100);
                                }
                            }
                            else {
                                $('select[name="'+selectElementId+'"]').val('')
                            }
                        },
                        templates: {
                            inputValue: function(result) {
                                return (!!result && result.displayName ? result.displayName : '');
                            },
                            suggestion: function(result) {
                                return !!result.displayName ? result.displayName : result;
                            }
                        }
                    })

            function customSuggest (query, syncResults) {
                var results = dataSource
                syncResults(query ? results.filter(function (result) {
                    return (result.synonyms.findIndex( function(s) { return s.toLowerCase().indexOf(query.toLowerCase()) !== -1 } ) !== -1 ) || (result.displayName.toLowerCase().indexOf(query.toLowerCase()) !== -1)
                }) : [])
            }
    </script>
}


@layout(
    pageTitle = Some(title(form, "journeyDetails.title")),
    headBlock = Some(head),
    scriptsBlock = Some(scripts),
    maybeBackButtonUrl = Some(backButtonUrl),
    maybeDeclarationType = Some(declarationType)
) {
  @formHelper(action =  JourneyDetailsController.onSubmit(), 'autoComplete -> "off", 'novalidate -> "novalidate") {
    @errorSummary(form.errors)
    @h1(messages("journeyDetails.heading"), classes = Some("govuk-fieldset__legend govuk-fieldset__legend--xl"))

    @inputSelect(
        form = form,
        id = port,
        name = port,
        items = PortService.getAllPorts.map(c => SelectItem(
            value = Some(c.code),
            text = messages(c.displayName),
            selected = form("port").value.contains(c.code)
        )),
        label = messages(s"journeyDetails.port.$declarationType.label"),
        isPageHeading = false,
        hint = Some("journeyDetails.port.hint")
    )

    @date(
        form = form,
        legendContent = messages(s"journeyDetails.dateOfTravel.$declarationType.label"),
        id = dateOfTravel,
        hintText = messages("journeyDetails.dateOfTravel.hint"),
        legendClasses = "govuk-fieldset__legend--s govuk-!-font-weight-regular"
    )

    @button("site.continue", name = Some("continue"))
  }
}
